# Ch.4 — Tools + Tool Calling 设计文档

**日期：** 2026-02-23
**章节目标：** 为 agent 添加工具调用能力，手写 ReAct 循环

---

## 目标

在 Ch.3 的 StateGraph 基础上叠加工具调用能力：
- 注册 calculator（纯 Python `@tool`）和 filesystem MCP server 工具
- 用 `ToolNode` + `tools_condition` 实现 ReAct 循环（无需手写 should_continue）
- MCP 工具异步懒加载，首次请求时初始化，避免修改 `main.py`

---

## 架构

```
START → chat_node → tools_condition ──→ tool_node → chat_node
                         └──────────────────────────→ END
```

- **chat_node**：`_llm_with_tools.invoke(state["messages"])`，返回带 tool_calls 的 AIMessage
- **tool_node**：`ToolNode(tools)`，prebuilt 节点，自动执行工具调用，返回 ToolMessage
- **tools_condition**：检查最后一条消息是否有 `tool_calls`，有则路由到 tool_node，无则路由到 END

---

## 文件变更

### 新增 `agent/tools.py`

```python
from langchain_core.tools import tool
from langchain_mcp_adapters.client import MultiServerMCPClient

@tool
def calculator(expression: str) -> str:
    """计算数学表达式，如 '2 + 2'、'sqrt(16)'"""
    return str(eval(expression, {"__builtins__": {}}))

async def get_all_tools() -> list:
    client = MultiServerMCPClient({
        "filesystem": {
            "transport": "stdio",
            "command": "npx",
            "args": ["-y", "@modelcontextprotocol/server-filesystem", "/tmp"],
        }
    })
    mcp_tools = await client.get_tools()
    return [calculator] + mcp_tools
```

### 更新 `agent/core.py`（懒加载）

- 模块级：`_llm`、`_checkpointer`、`_graph = None`、`_lock = asyncio.Lock()`
- `_get_graph()` 异步函数，双重检查锁，第一次调用时初始化工具并编译图
- `stream_agent` 先 `await _get_graph()`，其余不变

```
# 图拓扑
StateGraph(MessagesState)
  .add_node("chat", chat_node)       # LLM + bind_tools
  .add_node("tools", ToolNode(tools)) # prebuilt 工具执行
  .add_edge(START, "chat")
  .add_conditional_edges("chat", tools_condition)  # ReAct 路由
  .add_edge("tools", "chat")          # 工具执行后回到 LLM
  .compile(checkpointer=_checkpointer)
```

### 不变

- `main.py`、`routers/chat.py`、前端

---

## 依赖

```bash
uv add langchain-mcp-adapters
```

---

## 关键 API

| API | 来源 | 用途 |
|-----|------|------|
| `@tool` | `langchain_core.tools` | 声明 Python 工具 |
| `bind_tools(tools)` | LLM 对象 | 让 LLM 知道有哪些工具可调用 |
| `ToolNode` | `langgraph.prebuilt` | 自动执行 tool_calls，返回 ToolMessage |
| `tools_condition` | `langgraph.prebuilt` | 条件边函数，检查是否有 tool_calls |
| `MultiServerMCPClient` | `langchain_mcp_adapters.client` | 连接 MCP server，获取工具列表 |
| `add_conditional_edges` | `StateGraph` | 注册条件边 |

---

## 验收标准

1. 发送 "2的10次方是多少" → agent 调用 calculator → 返回 1024
2. 发送 "列出 /tmp 目录下的文件" → agent 调用 filesystem MCP 工具 → 返回文件列表
3. 普通对话（不需要工具）仍然正常流式返回
4. 行为与 Ch.3 纯对话路径完全兼容
